<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Estimator Pro</title>
    <style>
        /* General Styles */
        :root {
            --primary-color: #4a5568;
            --secondary-color: #2d3748;
            --accent-color: #4299e1;
            --background-color: #f7fafc;
            --text-color: #1a202c;
            --card-background: white;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Navigation */
        .nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: var(--card-background);
            color: var(--primary-color);
            border: 2px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Content */
        .content {
            background: var(--card-background);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            min-height: 500px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page h2 {
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        /* Grid and Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
            border-color: var(--accent-color);
        }

        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .card h3 {
            margin-bottom: 10px;
            color: var(--secondary-color);
        }

        .card p {
            color: #666;
            font-size: 14px;
        }

        /* Forms */
        .form {
            background: #fdfdff;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .form-input, .form-select, .search-bar {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .search-bar:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }

        /* Buttons */
        .btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
        }

        .btn:hover {
            opacity: 0.9;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn-secondary { background: #a0aec0; }
        .btn-success { background: #48bb78; }
        .btn-danger { background: #f56565; }
        .btn-warning { background: #ed8936; }
        .btn-info { background: #4299e1; }

        /* Calculator Styles */
        .calc-tabs, .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .calc-tab, .filter-tab {
            padding: 8px 16px;
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .calc-tab.active, .filter-tab.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .calc-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            max-width: 500px;
            margin: 20px auto;
            border: 1px solid var(--border-color);
        }

        .calc-display {
            width: 100%;
            height: 60px;
            font-size: 2rem;
            text-align: right;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 20px;
            background: white;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .calc-grid.scientific {
            grid-template-columns: repeat(5, 1fr);
        }

        .calc-btn {
            height: 60px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .calc-btn:hover { background: #f0f0f0; }
        .calc-btn.operator { background: #edf2f7; color: var(--accent-color); }
        .calc-btn.equals { background: var(--accent-color); color: white; }
        .calc-btn.clear { background: #fed7d7; color: #c53030; }
        .calc-btn.function { background: #e2e8f0; color: var(--secondary-color); }
        .calc-btn.zero { grid-column: span 2; }

        /* Table Styles */
        .table-wrapper {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        .table th, .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: var(--background-color);
            font-weight: 600;
        }

        .table tr:hover { background: #f7fafc; }
        .table input, .table select { border-radius: 4px; padding: 8px; }
        .table .item-total, .table .regional-price { font-weight: 600; }
        
        .table tfoot td {
            font-weight: bold;
        }
        
        .total-row {
            background: var(--secondary-color) !important;
            color: white;
            font-size: 1.1rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border: none;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .modal-buttons {
            margin-top: 20px;
            text-align: right;
            gap: 10px;
        }

        .calc-result {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #28a745;
            font-weight: bold;
        }
        
        .db-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .db-controls .search-bar {
            flex-grow: 1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid var(--accent-color);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }


        /* Responsive */
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .content, .header { padding: 20px; }
            .nav { flex-direction: column; align-items: center; }
            .nav-btn { width: 100%; max-width: 300px; text-align: center; }
            .db-controls { flex-direction: column; }
            .db-controls .search-bar { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🏗️ Construction Estimator Pro</h1>
            <p>Your all-in-one tool for accurate construction project estimation.</p>
        </header>
        
        <nav class="nav">
            <button class="nav-btn active" onclick="showPage('dashboard', this)">🏠 Dashboard</button>
            <button class="nav-btn" onclick="showPage('calculator', this)">🧮 Calculator</button>
            <button class="nav-btn" onclick="showPage('estimate', this)">📋 Estimate</button>
            <button class="nav-btn" onclick="showPage('database', this)">📚 Database</button>
            <button class="nav-btn" onclick="showPage('settings', this)">⚙️ Settings</button>
        </nav>
        
        <main class="content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <h2>Welcome to Your Dashboard</h2>
                 <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-estimates-stat">0</div>
                        <div class="stat-label">Total Estimates</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="database-items-stat">0</div>
                        <div class="stat-label">Database Items</div>
                    </div>
                </div>
                <div class="grid">
                    <div class="card" onclick="showPage('calculator')">
                        <div class="card-icon">🧮</div>
                        <h3>Calculators</h3>
                        <p>Access basic, scientific, and specialized construction calculators.</p>
                    </div>
                    <div class="card" onclick="showPage('estimate')">
                        <div class="card-icon">📋</div>
                        <h3>New Estimate</h3>
                        <p>Create a detailed cost estimate for your next project.</p>
                    </div>
                    <div class="card" onclick="showPage('database')">
                        <div class="card-icon">📚</div>
                        <h3>Price Database</h3>
                        <p>Manage your materials, labor, and equipment costs.</p>
                    </div>
                     <div class="card" onclick="showPage('settings')">
                        <div class="card-icon">⚙️</div>
                        <h3>Settings</h3>
                        <p>Configure tax, markup, and regional pricing factors.</p>
                    </div>
                </div>
            </div>
            
            <!-- Calculator Page -->
            <div id="calculator" class="page">
                <h2>Calculator Suite</h2>
                <div class="calc-tabs">
                    <button class="calc-tab active" onclick="showCalculator('basic', this)">Basic</button>
                    <button class="calc-tab" onclick="showCalculator('scientific', this)">Scientific</button>
                    <button class="calc-tab" onclick="showCalculator('area', this)">Area</button>
                    <button class="calc-tab" onclick="showCalculator('volume', this)">Volume</button>
                    <button class="calc-tab" onclick="showCalculator('material', this)">Materials</button>
                </div>
                
                <div id="basic-calc" class="calc-section">
                    <div class="calc-container">
                        <input type="text" id="basic-display" class="calc-display" value="0" readonly>
                        <div class="calc-grid">
                            <button class="calc-btn clear" onclick="clearBasic()">AC</button>
                            <button class="calc-btn operator" onclick="appendBasic('(')">(</button>
                            <button class="calc-btn operator" onclick="appendBasic(')')">)</button>
                             <button class="calc-btn clear" onclick="deleteBasic()">⌫</button>

                            <button class="calc-btn" onclick="appendBasic('7')">7</button>
                            <button class="calc-btn" onclick="appendBasic('8')">8</button>
                            <button class="calc-btn" onclick="appendBasic('9')">9</button>
                            <button class="calc-btn operator" onclick="appendBasic('/')">÷</button>
                            
                            <button class="calc-btn" onclick="appendBasic('4')">4</button>
                            <button class="calc-btn" onclick="appendBasic('5')">5</button>
                            <button class="calc-btn" onclick="appendBasic('6')">6</button>
                            <button class="calc-btn operator" onclick="appendBasic('*')">×</button>

                            <button class="calc-btn" onclick="appendBasic('1')">1</button>
                            <button class="calc-btn" onclick="appendBasic('2')">2</button>
                            <button class="calc-btn" onclick="appendBasic('3')">3</button>
                            <button class="calc-btn operator" onclick="appendBasic('-')">-</button>
                            
                            <button class="calc-btn zero" onclick="appendBasic('0')">0</button>
                            <button class="calc-btn" onclick="appendBasic('.')">.</button>
                            <button class="calc-btn operator" onclick="appendBasic('+')">+</button>
                            <button class="calc-btn equals" onclick="calculateBasic()">=</button>
                        </div>
                    </div>
                </div>

                <div id="scientific-calc" class="calc-section" style="display: none;">
                    <div class="calc-container">
                        <input type="text" id="sci-display" class="calc-display" value="0" readonly>
                        <div class="calc-grid scientific">
                            <button class="calc-btn function" onclick="sciFunction('sin')">sin</button>
                            <button class="calc-btn function" onclick="sciFunction('cos')">cos</button>
                            <button class="calc-btn function" onclick="sciFunction('tan')">tan</button>
                             <button class="calc-btn function" onclick="sciFunction('log')">log</button>
                            <button class="calc-btn clear" onclick="clearSci()">AC</button>

                            <button class="calc-btn function" onclick="sciFunction('sqrt')">√</button>
                            <button class="calc-btn function" onclick="sciFunction('pow')">x²</button>
                            <button class="calc-btn function" onclick="sciFunction('pi')">π</button>
                            <button class="calc-btn operator" onclick="appendSci('/')">÷</button>
                            <button class="calc-btn operator" onclick="appendSci('*')">×</button>
                            
                            <button class="calc-btn" onclick="appendSci('7')">7</button>
                            <button class="calc-btn" onclick="appendSci('8')">8</button>
                            <button class="calc-btn" onclick="appendSci('9')">9</button>
                            <button class="calc-btn operator" onclick="appendSci('-')">-</button>
                            <button class="calc-btn clear" onclick="deleteSci()">⌫</button>

                            <button class="calc-btn" onclick="appendSci('4')">4</button>
                            <button class="calc-btn" onclick="appendSci('5')">5</button>
                            <button class="calc-btn" onclick="appendSci('6')">6</button>
                            <button class="calc-btn operator" onclick="appendSci('+')">+</button>
                             <button class="calc-btn equals" rowspan="2" onclick="calculateSci()">=</button>

                            <button class="calc-btn" onclick="appendSci('1')">1</button>
                            <button class="calc-btn" onclick="appendSci('2')">2</button>
                            <button class="calc-btn" onclick="appendSci('3')">3</button>
                            <button class="calc-btn function" onclick="sciFunction('e')">e</button>

                            <button class="calc-btn zero" onclick="appendSci('0')">0</button>
                            <button class="calc-btn" onclick="appendSci('.')">.</button>
                            <button class="calc-btn function" onclick="sciFunction('%')">%</button>
                        </div>
                    </div>
                </div>
                
                <div id="area-calc" class="calc-section" style="display: none;">
                    <!-- Area Calculators will be dynamically inserted here -->
                </div>
                 <div id="volume-calc" class="calc-section" style="display: none;">
                    <!-- Volume Calculators will be dynamically inserted here -->
                </div>
                <div id="material-calc" class="calc-section" style="display: none;">
                    <!-- Material Calculators will be dynamically inserted here -->
                </div>
            </div>
            
            <!-- Estimate Page -->
            <div id="estimate" class="page">
                <h2>Construction Cost Estimator</h2>
                <div class="form">
                    <h3>Project Information</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Project Name</label>
                            <input type="text" class="form-input" id="project-name" placeholder="e.g., Downtown Office Reno">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Client Name</label>
                            <input type="text" class="form-input" id="client-name" placeholder="e.g., John Doe">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Project Date</label>
                            <input type="date" class="form-input" id="project-date">
                        </div>
                    </div>
                    <div class="form-row">
                         <div class="form-group">
                            <label class="form-label">Markup (%)</label>
                            <input type="number" class="form-input" id="markup-rate" value="15" step="0.01" onchange="updateEstimateTotal()">
                        </div>
                         <div class="form-group">
                            <label class="form-label">Tax Rate (%)</label>
                            <input type="number" class="form-input" id="tax-rate" value="8.25" step="0.01" onchange="updateEstimateTotal()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Regional Factor</label>
                            <select class="form-select" id="regional-factor" onchange="updateEstimateTotal()">
                                <option value="0.85">Rural (0.85)</option>
                                <option value="0.90">Southeast (0.90)</option>
                                <option value="0.95">Midwest (0.95)</option>
                                <option value="1.00" selected>National Average (1.00)</option>
                                <option value="1.10">Northeast (1.10)</option>
                                <option value="1.25">West Coast (1.25)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div>
                    <button class="btn btn-success" onclick="addEstimateItem()">➕ Add Item</button>
                    <button class="btn btn-danger" onclick="clearEstimate()">🗑️ Clear All</button>
                    <button class="btn btn-info" onclick="exportProposal()">📄 Generate Proposal</button>
                    <button class="btn" onclick="exportEstimateCSV()">📄 Export CSV</button>
                </div>
                
                <div class="table-wrapper">
                    <table class="table" id="estimate-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Category</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Unit Price</th>
                                <th>Regional Price</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="estimate-tbody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" style="text-align:right;">Subtotal</td>
                                <td id="estimate-subtotal">$0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="6" style="text-align:right;">Markup</td>
                                <td id="estimate-markup">$0.00</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td colspan="6" style="text-align:right;">Tax</td>
                                <td id="estimate-tax">$0.00</td>
                                <td></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="6" style="text-align:right;">TOTAL</td>
                                <td id="estimate-total">$0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Database Page -->
            <div id="database" class="page">
                <h2>Construction Price Database</h2>
                
                <div class="db-controls">
                    <input type="text" class="search-bar" id="database-search" placeholder="🔍 Search materials, labor, equipment..." onkeyup="searchDatabase()">
                    <button class="btn btn-success" onclick="showAddItemModal()">➕ Add New Item</button>
                    <button class="btn btn-info" onclick="importDatabase()">📥 Import</button>
                    <button class="btn" onclick="exportDatabase()">📤 Export</button>
                    <button class="btn btn-warning" onclick="resetDatabase()">🔄 Reset</button>
                </div>
                
                <div class="filter-tabs" id="db-filter-tabs">
                    <!-- Filters will be generated dynamically -->
                </div>
                
                <div class="table-wrapper">
                    <table class="table" id="database-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Category</th>
                                <th>Unit</th>
                                <th>Base Price</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="database-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings" class="page">
                 <h2>Settings</h2>
                <div class="form">
                    <h3>Defaults</h3>
                     <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Default Tax Rate (%)</label>
                            <input type="number" class="form-input" id="default-tax-rate" value="8.25" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Default Markup (%)</label>
                            <input type="number" class="form-input" id="default-markup" value="15" step="0.01">
                        </div>
                         <div class="form-group">
                            <label class="form-label">Default Regional Factor</label>
                            <select class="form-select" id="default-regional-factor">
                                <option value="0.85">Rural (0.85)</option>
                                <option value="0.90">Southeast (0.90)</option>
                                <option value="0.95">Midwest (0.95)</option>
                                <option value="1.00">National Average (1.00)</option>
                                <option value="1.10">Northeast (1.10)</option>
                                <option value="1.25">West Coast (1.25)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form">
                     <h3>Company Information</h3>
                     <div class="form-row">
                        <div class="form-group">
                             <label class="form-label">Company Name</label>
                             <input type="text" class="form-input" id="company-name" placeholder="Your Company Name">
                         </div>
                        <div class="form-group">
                             <label class="form-label">Contact Email</label>
                             <input type="email" class="form-input" id="company-email" placeholder="you@company.com">
                         </div>
                    </div>
                     <div class="form-group">
                         <label class="form-label">Company Address</label>
                         <textarea class="form-input" id="company-address" rows="3" placeholder="123 Main St, Anytown, USA"></textarea>
                     </div>
                </div>
                <button class="btn btn-success" onclick="saveSettings()">💾 Save Settings</button>
            </div>
        </main>
        
        <footer style="text-align: center; margin-top: 30px; color: #718096;">
            <p>© 2025 Construction Estimator Pro | All data is stored locally in your browser.</p>
        </footer>
    </div>

    <!-- Modal for Add/Edit Items -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Add New Item</h3>
            <div class="form">
                <div class="form-group">
                    <label class="form-label">Item Name</label>
                    <input type="text" class="form-input" id="modal-item-name" placeholder="e.g., 2x4x8 Framing Lumber">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-input" id="modal-category" placeholder="e.g., Lumber & Wood">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit</label>
                        <input type="text" class="form-input" id="modal-unit" placeholder="e.g., each, sq ft, hour">
                    </div>
                </div>
                 <div class="form-group">
                    <label class="form-label">Base Price ($)</label>
                    <input type="number" class="form-input" id="modal-price" step="0.01" placeholder="0.00">
                </div>
            </div>
            <div class="modal-buttons">
                <button id="modal-cancel" class="btn btn-secondary">Cancel</button>
                <button id="modal-save" class="btn btn-success">Save</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 id="confirm-title">Are you sure?</h3>
            <p id="confirm-text"></p>
            <div class="modal-buttons">
                <button id="confirm-cancel" class="btn btn-secondary">Cancel</button>
                <button id="confirm-ok" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <h3 id="alert-title">Notification</h3>
            <p id="alert-text"></p>
            <div class="modal-buttons">
                <button id="alert-ok" class="btn">OK</button>
            </div>
        </div>
    </div>

    <script>
    // --- GLOBAL VARIABLES & STATE ---
    let databaseItems = [];
    let estimates = [];
    let currentFilter = 'All';
    let editingItemIndex = -1;
    let confirmCallback = null;
    let pageElements = {};
    let modalElements = {};
    
    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Assign elements now that the DOM is loaded
        pageElements = {
            dashboard: document.getElementById('dashboard'),
            calculator: document.getElementById('calculator'),
            estimate: document.getElementById('estimate'),
            database: document.getElementById('database'),
            settings: document.getElementById('settings'),
        };
        modalElements = {
            item: document.getElementById('itemModal'),
            confirm: document.getElementById('confirmModal'),
            alert: document.getElementById('alertModal'),
        };

        loadSettings();
        loadDatabase();
        loadEstimates();
        
        showPage('dashboard', document.querySelector('.nav-btn'));
        updateDashboardStats();
        
        setupModalListeners();
        createCalculatorSections();
    });

    // --- NAVIGATION & UI ---
    function showPage(pageId, clickedBtn) {
        Object.values(pageElements).forEach(page => page.style.display = 'none');
        document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

        document.getElementById(pageId).style.display = 'block';
        if (clickedBtn) {
            clickedBtn.classList.add('active');
        } else {
            document.querySelector(`.nav-btn[onclick*="'${pageId}'"]`)?.classList.add('active');
        }
        
        if (pageId === 'database') displayDatabase();
        if (pageId === 'dashboard') updateDashboardStats();
    }

    function showCalculator(type, clickedTab) {
        document.querySelectorAll('.calc-section').forEach(section => section.style.display = 'none');
        document.getElementById(type + '-calc').style.display = 'block';
        document.querySelectorAll('#calculator .calc-tab').forEach(tab => tab.classList.remove('active'));
        clickedTab.classList.add('active');
    }
    
    function updateDashboardStats() {
        document.getElementById('total-estimates-stat').textContent = estimates.length;
        document.getElementById('database-items-stat').textContent = databaseItems.length;
    }

    // --- DATABASE MANAGEMENT ---
    function loadDatabase() {
        const savedDB = localStorage.getItem('constructionDatabase');
        if (savedDB) {
            databaseItems = JSON.parse(savedDB);
        } else {
             const defaultDatabase = [
                {item: "Concrete 3000 PSI", category: "Concrete & Masonry", unit: "cubic yard", price: 175.00},
                {item: "Rebar #4", category: "Concrete & Masonry", unit: "linear foot", price: 1.35},
                {item: "8\" CMU Block", category: "Concrete & Masonry", unit: "each", price: 2.50},
                {item: "Framing Lumber 2x4x8", category: "Lumber & Wood", unit: "each", price: 6.20},
                {item: "1/2\" CDX Plywood", category: "Lumber & Wood", unit: "sheet", price: 38.00},
                {item: "General Labor", category: "Labor", unit: "hour", price: 25.00},
                {item: "Skilled Carpenter", category: "Labor", unit: "hour", price: 45.00},
                {item: "1/2\" Drywall", category: "Finishes", unit: "sheet", price: 15.00},
                {item: "Interior Latex Paint", category: "Finishes", unit: "gallon", price: 40.00}
            ];
            databaseItems = defaultDatabase;
            showAlert("Default database loaded. You can import your own from the Database page.");
        }
        finishDatabaseLoad();
    }
    
    function finishDatabaseLoad() {
        saveDatabase(); 
        generateDbFilters();
        displayDatabase();
    }

    function saveDatabase() {
        localStorage.setItem('constructionDatabase', JSON.stringify(databaseItems));
        generateDbFilters();
        displayDatabase();
        updateDashboardStats();
    }
    
    function displayDatabase() {
        const tbody = document.getElementById('database-tbody');
        tbody.innerHTML = '';
        
        let filteredItems = databaseItems;
        if (currentFilter !== 'All') {
            filteredItems = databaseItems.filter(item => item.category === currentFilter);
        }
        
        const searchTerm = document.getElementById('database-search').value.toLowerCase();
        if (searchTerm) {
            filteredItems = filteredItems.filter(item => 
                item.item.toLowerCase().includes(searchTerm) ||
                item.category.toLowerCase().includes(searchTerm)
            );
        }

        const fragment = document.createDocumentFragment();
        filteredItems.forEach((item, index) => {
            const originalIndex = databaseItems.indexOf(item);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.item}</td>
                <td>${item.category}</td>
                <td>${item.unit}</td>
                <td>$${item.price.toFixed(2)}</td>
                <td>
                    <button class="btn btn-info" onclick="editDatabaseItem(${originalIndex})" title="Edit">✏️</button>
                    <button class="btn btn-danger" onclick="deleteDatabaseItem(${originalIndex})" title="Delete">🗑️</button>
                    <button class="btn" onclick="addToEstimateFromDb(${originalIndex})" title="Add to Estimate">➕</button>
                </td>
            `;
            fragment.appendChild(row);
        });
        tbody.appendChild(fragment);
    }

    function generateDbFilters() {
        const categories = ['All', ...new Set(databaseItems.map(item => item.category))];
        const filterContainer = document.getElementById('db-filter-tabs');
        filterContainer.innerHTML = '';
        categories.forEach(cat => {
            const btn = document.createElement('button');
            btn.className = `filter-tab ${currentFilter === cat ? 'active' : ''}`;
            btn.textContent = cat;
            btn.onclick = () => filterDatabase(cat, btn);
            filterContainer.appendChild(btn);
        });
    }

    function filterDatabase(category, clickedTab) {
        currentFilter = category;
        document.querySelectorAll('#db-filter-tabs .filter-tab').forEach(tab => tab.classList.remove('active'));
        clickedTab.classList.add('active');
        displayDatabase();
    }

    function searchDatabase() {
        displayDatabase();
    }
    
    function showAddItemModal() {
        editingItemIndex = -1;
        document.getElementById('modal-title').textContent = 'Add New Item';
        document.getElementById('modal-item-name').value = '';
        document.getElementById('modal-category').value = '';
        document.getElementById('modal-unit').value = '';
        document.getElementById('modal-price').value = '';
        modalElements.item.style.display = 'flex';
    }

    function editDatabaseItem(index) {
        editingItemIndex = index;
        const item = databaseItems[index];
        document.getElementById('modal-title').textContent = 'Edit Item';
        document.getElementById('modal-item-name').value = item.item;
        document.getElementById('modal-category').value = item.category;
        document.getElementById('modal-unit').value = item.unit;
        document.getElementById('modal-price').value = item.price;
        modalElements.item.style.display = 'flex';
    }

    function deleteDatabaseItem(index) {
        const item = databaseItems[index];
        showConfirm(`Are you sure you want to delete "${item.item}"? This action cannot be undone.`, () => {
            databaseItems.splice(index, 1);
            saveDatabase();
            showAlert('Item deleted successfully!');
        });
    }

    function resetDatabase() {
        showConfirm('This will delete all your local changes and restore the default database. Are you sure?', () => {
            localStorage.removeItem('constructionDatabase');
            loadDatabase();
            showAlert('Database has been reset to default.');
        });
    }

    // --- ESTIMATE MANAGEMENT ---
    function loadEstimates() {
        const saved = localStorage.getItem('constructionEstimates');
        estimates = saved ? JSON.parse(saved) : [];
    }

    function addEstimateItem() {
        const tbody = document.getElementById('estimate-tbody');
        const newRow = tbody.insertRow();
        newRow.innerHTML = `
            <td><input type="text" class="form-input" placeholder="Item name" oninput="updateEstimateRow(this.closest('tr'))"></td>
            <td><input type="text" class="form-input" placeholder="Category" oninput="updateEstimateRow(this.closest('tr'))"></td>
            <td><input type="number" class="form-input" value="1" step="0.01" oninput="updateEstimateRow(this.closest('tr'))"></td>
            <td><input type="text" class="form-input" placeholder="unit" oninput="updateEstimateRow(this.closest('tr'))"></td>
            <td><input type="number" class="form-input" value="0.00" step="0.01" oninput="updateEstimateRow(this.closest('tr'))"></td>
            <td class="regional-price">$0.00</td>
            <td class="item-total">$0.00</td>
            <td><button class="btn btn-danger" onclick="removeEstimateItem(this)">🗑️</button></td>
        `;
        updateEstimateRow(newRow);
    }
    
    function addToEstimateFromDb(index) {
        const item = databaseItems[index];
        showPage('estimate');
        const tbody = document.getElementById('estimate-tbody');
        const newRow = tbody.insertRow();
        newRow.innerHTML = `
            <td><input type="text" class="form-input" value="${item.item}" oninput="updateEstimateRow(this.closest('tr'))"></td>
            <td><input type="text" class="form-input" value="${item.category}" oninput="updateEstimateRow(this.closest('tr'))"></td>
            <td><input type="number" class="form-input" value="1" step="0.01" oninput="updateEstimateRow(this.closest('tr'))"></td>
            <td><input type="text" class="form-input" value="${item.unit}" oninput="updateEstimateRow(this.closest('tr'))"></td>
            <td><input type="number" class="form-input" value="${item.price.toFixed(2)}" step="0.01" oninput="updateEstimateRow(this.closest('tr'))"></td>
            <td class="regional-price">$0.00</td>
            <td class="item-total">$0.00</td>
            <td><button class="btn btn-danger" onclick="removeEstimateItem(this)">🗑️</button></td>
        `;
        updateEstimateRow(newRow);
        showAlert(`Added "${item.item}" to your estimate.`);
    }

    function removeEstimateItem(button) {
        const row = button.closest('tr');
        row.parentNode.removeChild(row);
        updateEstimateTotal();
    }

    function updateEstimateRow(row) {
        const regionalFactor = parseFloat(document.getElementById('regional-factor').value) || 1.0;
        const quantity = parseFloat(row.cells[2].querySelector('input').value) || 0;
        const basePrice = parseFloat(row.cells[4].querySelector('input').value) || 0;
        
        const regionalPrice = basePrice * regionalFactor;
        const itemTotal = quantity * regionalPrice;

        row.cells[5].textContent = `$${regionalPrice.toFixed(2)}`;
        row.cells[6].textContent = `$${itemTotal.toFixed(2)}`;
        
        updateEstimateTotal();
    }

    function updateEstimateTotal() {
        const rows = document.querySelectorAll('#estimate-tbody tr');
        let subtotal = 0;
        rows.forEach(row => {
            const itemTotal = parseFloat(row.cells[6].textContent.replace('$', '')) || 0;
            subtotal += itemTotal;
        });
        
        const markupRate = parseFloat(document.getElementById('markup-rate').value) / 100 || 0;
        const markup = subtotal * markupRate;
        
        const taxRate = parseFloat(document.getElementById('tax-rate').value) / 100 || 0;
        const taxableAmount = subtotal + markup;
        const tax = taxableAmount * taxRate;
        
        const total = taxableAmount + tax;

        document.getElementById('estimate-subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('estimate-markup').textContent = `$${markup.toFixed(2)}`;
        document.getElementById('estimate-tax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('estimate-total').textContent = `$${total.toFixed(2)}`;
    }
    
    function clearEstimate() {
        showConfirm('Are you sure you want to clear all estimate items?', () => {
            document.getElementById('estimate-tbody').innerHTML = '';
            updateEstimateTotal();
        });
    }

    // --- IMPORT / EXPORT / PROPOSAL ---
    function exportDatabase() {
        const dataStr = JSON.stringify(databaseItems, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'construction_database.json';
        link.click();
        URL.revokeObjectURL(url);
    }

    function importDatabase() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (Array.isArray(importedData)) {
                             showConfirm('This will overwrite your current database. Proceed?', () => {
                                databaseItems = importedData;
                                saveDatabase();
                                showAlert('Database imported successfully!');
                            });
                        } else {
                           showAlert('Error: Invalid database file format.', true);
                        }
                    } catch (error) {
                        showAlert('Error importing database. Please check file format.', true);
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }
    
    function exportEstimateCSV() {
        let csvContent = "data:text/csv;charset=utf-8,";
        
        const projectName = document.getElementById('project-name').value || 'Untitled';
        csvContent += `Project Name,${projectName}\n\n`;
        
        csvContent += "Item,Category,Quantity,Unit,Unit Price,Regional Price,Total\n";
        
        document.querySelectorAll("#estimate-tbody tr").forEach(row => {
            const cells = Array.from(row.cells).slice(0, -1); // Exclude action button
            const rowData = cells.map((cell, index) => {
                let cellText = cell.querySelector('input') ? cell.querySelector('input').value : cell.textContent;
                return `"${cellText.replace(/"/g, '""')}"`; // Escape double quotes
            });
            csvContent += rowData.join(",") + "\n";
        });

        // Add totals
        csvContent += `\n,,,,,Subtotal,"${document.getElementById('estimate-subtotal').textContent}"\n`;
        csvContent += `,,,,,Markup,"${document.getElementById('estimate-markup').textContent}"\n`;
        csvContent += `,,,,,Tax,"${document.getElementById('estimate-tax').textContent}"\n`;
        csvContent += `,,,,,TOTAL,"${document.getElementById('estimate-total').textContent}"\n`;

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `${projectName}_estimate.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function exportProposal() {
        const companyName = document.getElementById('company-name').value || 'Your Company Name';
        const companyEmail = document.getElementById('company-email').value || 'your@email.com';
        const companyAddress = document.getElementById('company-address').value.replace(/\n/g, '<br>') || 'Your Company Address';

        const projectName = document.getElementById('project-name').value || 'Untitled Project';
        const clientName = document.getElementById('client-name').value || 'Valued Client';
        const projectDate = document.getElementById('project-date').value ? new Date(document.getElementById('project-date').value).toLocaleDateString() : new Date().toLocaleDateString();

        let tableContent = '';
        document.querySelectorAll("#estimate-tbody tr").forEach(row => {
            const cells = row.cells;
            tableContent += `
                <tr>
                    <td>${cells[0].querySelector('input').value}</td>
                    <td>${cells[1].querySelector('input').value}</td>
                    <td>${cells[2].querySelector('input').value}</td>
                    <td>${cells[4].querySelector('input').value}</td>
                    <td>${cells[6].textContent}</td>
                </tr>
            `;
        });
        
        const proposalHTML = `
            <html>
            <head>
                <title>Proposal - ${projectName}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; color: #333; }
                    .container { max-width: 800px; margin: 40px auto; background: white; padding: 50px; box-shadow: 0 0 20px rgba(0,0,0,0.1); border-radius: 8px; }
                    .header, .footer { text-align: center; margin-bottom: 40px; }
                    .header h1 { color: #2d3748; margin: 0; }
                    .header p { margin: 5px 0; color: #718096; }
                    .info-section { display: flex; justify-content: space-between; margin-bottom: 40px; }
                    .info-section div { width: 48%; }
                    h2, h3 { color: #2d3748; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; margin-bottom: 20px; }
                    table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
                    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
                    th { background-color: #f7fafc; font-weight: 600; }
                    td:last-child, th:last-child { text-align: right; }
                    .totals-table { width: 50%; margin-left: auto; margin-top: 20px; }
                    .totals-table td { border: none; }
                    .totals-table tr td:first-child { text-align: right; font-weight: bold; color: #4a5568; }
                    .totals-table .total-row td { font-weight: bold; font-size: 1.2em; border-top: 2px solid #2d3748; padding-top: 10px; }
                    .terms-section { margin-top: 40px; font-size: 0.8em; color: #4a5568; }
                    .terms-section p { margin-bottom: 10px; }
                    .acceptance-section { margin-top: 50px; padding-top: 30px; border-top: 2px solid #e2e8f0; }
                    .signature-line { border-bottom: 1px solid #333; width: 300px; margin-top: 50px; }
                    .footer { margin-top: 50px; font-size: 0.9em; color: #888; border-top: 1px solid #e2e8f0; padding-top: 20px; }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>${companyName}</h1>
                        <p>${companyAddress}</p>
                        <p>${companyEmail}</p>
                    </div>

                    <div class="info-section">
                        <div>
                            <h3>Bill To:</h3>
                            <p>${clientName}</p>
                        </div>
                        <div>
                            <h3>Project Details:</h3>
                            <p><strong>Project:</strong> ${projectName}</p>
                            <p><strong>Date:</strong> ${projectDate}</p>
                        </div>
                    </div>
                    
                    <h2>Cost Estimate</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Item Description</th>
                                <th>Category</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>${tableContent}</tbody>
                    </table>
                    
                    <table class="totals-table">
                        <tr><td>Subtotal:</td><td>${document.getElementById('estimate-subtotal').textContent}</td></tr>
                        <tr><td>Markup:</td><td>${document.getElementById('estimate-markup').textContent}</td></tr>
                        <tr><td>Tax:</td><td>${document.getElementById('estimate-tax').textContent}</td></tr>
                        <tr class="total-row"><td>TOTAL:</td><td>${document.getElementById('estimate-total').textContent}</td></tr>
                    </table>

                    <div class="terms-section">
                        <h3>Terms and Conditions</h3>
                        <p><strong>1. Scope of Work:</strong> The work to be performed is limited to the items specified in this proposal. Any additional work requested by the client will require a written change order and may result in additional charges.</p>
                        <p><strong>2. Changes to Work:</strong> All changes to the scope of work must be documented in a written change order signed by both the client and ${companyName}.</p>
                        <p><strong>3. Payment Schedule:</strong> Payments are due as outlined in the project contract. Late payments may be subject to interest charges of 1.5% per month.</p>
                        <p><strong>4. Project Timeline:</strong> Any provided timeline is a good-faith estimate and may be affected by unforeseen circumstances, such as weather delays, permit issues, or changes to the scope of work.</p>
                        <p><strong>5. Permits and Inspections:</strong> Client is responsible for securing and paying for all necessary permits and inspections unless otherwise specified in writing.</p>
                        <p><strong>6. Limited Warranty:</strong> ${companyName} warrants its workmanship for a period of one (1) year from the date of substantial completion. This warranty does not cover materials, which are subject to their respective manufacturer's warranties.</p>
                        <p><strong>7. Liability:</strong> ${companyName}'s liability is limited to the total amount of this proposal.</p>
                    </div>

                    <div class="acceptance-section">
                        <h3>Proposal Acceptance</h3>
                        <p>This proposal is valid for 30 days from the date of issuance. Your signature below indicates acceptance of the terms and conditions outlined in this document.</p>
                        <br><br>
                        <p><strong>Accepted By:</strong></p>
                        <div class="signature-line"></div>
                        <p>${clientName}</p>
                        <br><br>
                        <p><strong>Date:</strong></p>
                        <div class="signature-line"></div>
                    </div>

                    <div class="footer">
                        <p>Thank you for your business!</p>
                    </div>
                </div>
            </body>
            </html>
        `;
        
        const proposalWindow = window.open('', '_blank');
        proposalWindow.document.write(proposalHTML);
        proposalWindow.document.close();
    }


    // --- CALCULATORS ---
    // Basic & Scientific Calculators
    function appendToDisplay(displayId, value) {
        const display = document.getElementById(displayId);
        if (display.value === '0' && value !== '.') {
            display.value = value;
        } else {
            display.value += value;
        }
    }
    
    function appendBasic(value) { appendToDisplay('basic-display', value); }
    function appendSci(value) { appendToDisplay('sci-display', value); }
    function clearBasic() { document.getElementById('basic-display').value = '0'; }
    function clearSci() { document.getElementById('sci-display').value = '0'; }
    
    function deleteFromDisplay(displayId) {
        const display = document.getElementById(displayId);
        display.value = display.value.slice(0, -1) || '0';
    }
    
    function deleteBasic() { deleteFromDisplay('basic-display'); }
    function deleteSci() { deleteFromDisplay('sci-display'); }

    function calculate(displayId) {
        const display = document.getElementById(displayId);
        try {
            // Replace visual operators with evaluatable ones
            const expression = display.value.replace(/×/g, '*').replace(/÷/g, '/');
            const result = new Function('return ' + expression)();
            display.value = result;
        } catch (error) {
            display.value = 'Error';
        }
    }

    function calculateBasic() { calculate('basic-display'); }
    function calculateSci() { calculate('sci-display'); }

    function sciFunction(func) {
        const display = document.getElementById('sci-display');
        const value = parseFloat(display.value);
        let result = 0;
        switch(func) {
            case 'sin': result = Math.sin(value * Math.PI / 180); break;
            case 'cos': result = Math.cos(value * Math.PI / 180); break;
            case 'tan': result = Math.tan(value * Math.PI / 180); break;
            case 'log': result = Math.log10(value); break;
            case 'sqrt': result = Math.sqrt(value); break;
            case 'pow': result = Math.pow(value, 2); break;
            case 'pi': result = Math.PI; break;
            case 'e': result = Math.E; break;
            case '%': result = value / 100; break;
        }
        display.value = result;
    }

    // Specialized Calculators
    function createCalculatorSections() {
        const areaContainer = document.getElementById('area-calc');
        areaContainer.innerHTML = `
            <h3>Area Calculators</h3>
            <div class="form">
                <h4>Rectangle</h4>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Length (ft)</label><input type="number" class="form-input" id="rect-length"></div>
                    <div class="form-group"><label class="form-label">Width (ft)</label><input type="number" class="form-input" id="rect-width"></div>
                </div>
                <button class="btn" onclick="calculateRectangle()">Calculate</button>
                <div id="rect-result" class="calc-result" style="display: none;"></div>
            </div>
             <div class="form">
                <h4>Circle</h4>
                <div class="form-group"><label class="form-label">Radius (ft)</label><input type="number" class="form-input" id="circle-radius"></div>
                <button class="btn" onclick="calculateCircle()">Calculate</button>
                <div id="circle-result" class="calc-result" style="display: none;"></div>
            </div>
        `;

        const volumeContainer = document.getElementById('volume-calc');
        volumeContainer.innerHTML = `
             <h3>Volume Calculators</h3>
            <div class="form">
                <h4>Slab / Rectangle</h4>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Length (ft)</label><input type="number" class="form-input" id="concrete-length"></div>
                    <div class="form-group"><label class="form-label">Width (ft)</label><input type="number" class="form-input" id="concrete-width"></div>
                    <div class="form-group"><label class="form-label">Thickness (in)</label><input type="number" class="form-input" id="concrete-thickness"></div>
                </div>
                <button class="btn" onclick="calculateConcrete()">Calculate</button>
                <div id="concrete-result" class="calc-result" style="display: none;"></div>
            </div>
        `;
        
         const materialContainer = document.getElementById('material-calc');
        materialContainer.innerHTML = `
             <h3>Material Calculators</h3>
            <div class="form">
                <h4>Lumber (Studs)</h4>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Wall Length (ft)</label><input type="number" class="form-input" id="lumber-length"></div>
                     <div class="form-group"><label class="form-label">Stud Spacing (in)</label><select class="form-select" id="lumber-spacing"><option value="16">16" O.C.</option><option value="24">24" O.C.</option></select></div>
                </div>
                <button class="btn" onclick="calculateLumber()">Calculate</button>
                <div id="lumber-result" class="calc-result" style="display: none;"></div>
            </div>
        `;
    }

    function calculateRectangle() {
        const length = parseFloat(document.getElementById('rect-length').value);
        const width = parseFloat(document.getElementById('rect-width').value);
        if (length && width) {
            const area = length * width;
            const resultDiv = document.getElementById('rect-result');
            resultDiv.innerHTML = `Area: ${area.toFixed(2)} sq ft`;
            resultDiv.style.display = 'block';
        }
    }
    
    function calculateCircle() {
        const radius = parseFloat(document.getElementById('circle-radius').value);
        if (radius) {
            const area = Math.PI * radius * radius;
             const resultDiv = document.getElementById('circle-result');
            resultDiv.innerHTML = `Area: ${area.toFixed(2)} sq ft`;
            resultDiv.style.display = 'block';
        }
    }
    
     function calculateConcrete() {
        const length = parseFloat(document.getElementById('concrete-length').value);
        const width = parseFloat(document.getElementById('concrete-width').value);
        const thickness = parseFloat(document.getElementById('concrete-thickness').value);
        
        if (length && width && thickness) {
            const volumeCuFt = length * width * (thickness / 12);
            const volumeCuYd = volumeCuFt / 27;
            const bags80lb = Math.ceil(volumeCuYd / 0.0222); // Approx 0.0222 cu yd per 80lb bag
            const bags60lb = Math.ceil(volumeCuYd / 0.0167); // Approx 0.0167 cu yd per 60lb bag
            
            const resultDiv = document.getElementById('concrete-result');
            resultDiv.innerHTML = `
                Volume: ${volumeCuYd.toFixed(2)} cubic yards (${volumeCuFt.toFixed(2)} cubic feet)<br>
                Estimated Bags: ~${bags80lb} (80lb) or ~${bags60lb} (60lb)
            `;
            resultDiv.style.display = 'block';
        }
    }

    function calculateLumber() {
        const length = parseFloat(document.getElementById('lumber-length').value);
        const spacing = parseFloat(document.getElementById('lumber-spacing').value);
        if (length && spacing) {
            const studs = Math.ceil((length * 12) / spacing) + 1;
            const resultDiv = document.getElementById('lumber-result');
            resultDiv.innerHTML = `Studs Needed: ${studs} pieces`;
            resultDiv.style.display = 'block';
        }
    }


    // --- MODAL & ALERT HANDLING ---
    function setupModalListeners() {
        // Item Modal
        modalElements.item.querySelector('#modal-save').onclick = () => {
            const newItem = {
                item: document.getElementById('modal-item-name').value,
                category: document.getElementById('modal-category').value,
                unit: document.getElementById('modal-unit').value,
                price: parseFloat(document.getElementById('modal-price').value) || 0
            };
            
            if (!newItem.item || !newItem.category || !newItem.unit) {
                showAlert("Please fill in all fields.", true);
                return;
            }

            if (editingItemIndex > -1) {
                databaseItems[editingItemIndex] = newItem;
            } else {
                databaseItems.push(newItem);
            }
            saveDatabase();
            modalElements.item.style.display = 'none';
        };
        modalElements.item.querySelector('#modal-cancel').onclick = () => modalElements.item.style.display = 'none';

        // Confirm Modal
        modalElements.confirm.querySelector('#confirm-ok').onclick = () => {
            if (confirmCallback) confirmCallback();
            modalElements.confirm.style.display = 'none';
        };
        modalElements.confirm.querySelector('#confirm-cancel').onclick = () => modalElements.confirm.style.display = 'none';
        
         // Alert Modal
        modalElements.alert.querySelector('#alert-ok').onclick = () => modalElements.alert.style.display = 'none';
    }

    function showConfirm(text, callback) {
        document.getElementById('confirm-text').textContent = text;
        confirmCallback = callback;
        modalElements.confirm.style.display = 'flex';
    }

    function showAlert(text, isError = false) {
        document.getElementById('alert-text').textContent = text;
        document.getElementById('alert-title').textContent = isError ? 'Error' : 'Notification';
        modalElements.alert.style.display = 'flex';
    }
    
    // --- SETTINGS ---
    function loadSettings() {
        const settings = JSON.parse(localStorage.getItem('constructionSettings')) || {};
        document.getElementById('default-tax-rate').value = settings.taxRate || '8.25';
        document.getElementById('default-markup').value = settings.markupRate || '15';
        document.getElementById('default-regional-factor').value = settings.regionalFactor || '1.00';
        document.getElementById('company-name').value = settings.companyName || '';
        document.getElementById('company-email').value = settings.companyEmail || '';
        document.getElementById('company-address').value = settings.companyAddress || '';
        
        // Apply to estimate page
        document.getElementById('tax-rate').value = settings.taxRate || '8.25';
        document.getElementById('markup-rate').value = settings.markupRate || '15';
        document.getElementById('regional-factor').value = settings.regionalFactor || '1.00';
    }

    function saveSettings() {
        const settings = {
            taxRate: document.getElementById('default-tax-rate').value,
            markupRate: document.getElementById('default-markup').value,
            regionalFactor: document.getElementById('default-regional-factor').value,
            companyName: document.getElementById('company-name').value,
            companyEmail: document.getElementById('company-email').value,
            companyAddress: document.getElementById('company-address').value,
        };
        localStorage.setItem('constructionSettings', JSON.stringify(settings));
        showAlert('Settings saved successfully!');
        loadSettings(); // Re-apply to ensure consistency
    }

    </script>
</body>
</html>
