<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eTakeoff & RSMeans - Redesigned UI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        :root {
            --primary-bg: #f8f9fa;
            --secondary-bg: #ffffff;
            --header-bg: #ffffff;
            --border-color: #dee2e6;
            --text-dark: #212529;
            --text-muted: #6c757d;
            --accent-color: #0d6efd;
            --accent-color-hover: #0b5ed7;
            --sidebar-bg: #343a40;
            --takeoff-viewer-bg: #525659;
            --shadow-sm: 0 .125rem .25rem rgba(0,0,0,.075);
            --takeoff-linear-color: #ffc107;
            --takeoff-area-color: #198754;
            --takeoff-count-color: #dc3545;
            --info-bg: #e9f5ff;
            --info-border: #aed9ff;
        }

        body.night-mode {
            --primary-bg: #1a202c;
            --secondary-bg: #2d3748;
            --header-bg: #2d3748;
            --border-color: #4a5568;
            --text-dark: #f8f9fa;
            --text-muted: #a0aec0;
            --sidebar-bg: #212529;
            --takeoff-viewer-bg: #1a202c;
            --info-bg: #2b3a55;
            --info-border: #4a5568;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--primary-bg);
            color: var(--text-dark);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .main-header {
            display: flex; align-items: center; justify-content: space-between; padding: 0 24px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            height: 65px; flex-shrink: 0; z-index: 1000;
        }
        .main-header .logo { font-size: 1.6rem; font-weight: 700; display: flex; align-items: center; gap: 12px;}
        .main-header .logo i { color: var(--accent-color); }
        
        .main-container { display: flex; flex-grow: 1; height: calc(100vh - 65px); }
        
        .sidebar {
            width: 240px; background: var(--sidebar-bg); display: flex; flex-direction: column;
            padding-top: 20px; flex-shrink: 0;
        }
        .tab-btn {
            display: flex; align-items: center; gap: 15px; padding: 16px 24px; color: var(--text-muted);
            background: none; border: none; width: 100%; text-align: left;
            font-size: 16px; font-weight: 600; cursor: pointer; border-left: 4px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .tab-btn i { width: 20px; }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .tab-btn.active { background: rgba(0,0,0,0.2); color: #fff; border-left-color: var(--accent-color); }

        .content-area { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; }
        .page { display: none; height: 100%; overflow-y: auto; padding: 30px; }
        .page.active { display: flex; flex-direction: column; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 24px; margin-bottom: 24px; }
        .card-header { padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--border-color); }
        .btn {
            background: var(--accent-color); color: white; border: none; padding: 10px 20px; border-radius: 6px;
            cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { background: var(--accent-color-hover); }

        #dashboard-page .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
        .stat-card { text-align: center; }
        .stat-card .value { font-size: 2.5rem; font-weight: 700; color: var(--accent-color); }
        .stat-card .label { font-size: 1rem; font-weight: 500; color: var(--text-muted); }

        #takeoff-page { flex-direction: row; padding: 0; gap: 0; }
        .takeoff-main-panel { flex-grow: 1; background: var(--takeoff-viewer-bg); display: flex; flex-direction: column; }
        .takeoff-toolbar {
            display: flex; align-items: center; gap: 10px; padding: 10px; background: #212529;
            flex-shrink: 0; border-bottom: 1px solid #495057;
        }
        .toolbar-btn { background: none; border: 1px solid #6c757d; color: #f8f9fa; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .toolbar-btn.active, .toolbar-btn:hover { background: var(--accent-color); border-color: var(--accent-color); }
        .takeoff-viewer {
            flex-grow: 1; overflow: auto; display: flex; justify-content: center;
            align-items: flex-start; padding: 20px; position: relative;
        }
        #pdf-canvas-container { position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        #pdf-canvas, #draw-canvas { position: absolute; top: 0; left: 0; }
        #draw-canvas { z-index: 10; cursor: crosshair; }
        
        .takeoff-sidebar {
            width: 320px; background: var(--secondary-bg); padding: 20px;
            border-left: 1px solid var(--border-color); display: flex; flex-direction: column;
        }
        #pending-takeoff {
            background: var(--info-bg); border: 1px solid var(--info-border); border-radius: 6px;
            padding: 15px; text-align: center; margin-bottom: 15px; display: none;
        }
        .takeoff-log { flex-grow: 1; overflow-y: auto; }
        .log-item {
            padding: 10px; font-size: 14px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }

        .table-wrapper { overflow-x: auto; border: 1px solid var(--border-color); border-radius: 8px; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background: var(--primary-bg); font-weight: 600; }
        
        .theme-switch-wrapper { display: flex; align-items: center; }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 44px; }
        .theme-switch input { display:none; }
        .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; }
        .slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

    </style>
</head>
<body>
    <header class="main-header">
        <div class="logo"><i class="fas fa-drafting-compass"></i> eTakeoff Pro</div>
        <div class="theme-switch-wrapper">
             <i class="fas fa-sun" style="margin-right: 10px; font-size: 14px;"></i>
             <label class="theme-switch">
                <input type="checkbox" id="theme-toggle" onchange="App.toggleTheme()">
                <span class="slider round"></span>
            </label>
            <i class="fas fa-moon" style="margin-left: 10px; font-size: 14px;"></i>
        </div>
    </header>
    <div class="main-container">
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <button class="tab-btn active" onclick="App.navigateToTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
                <button class="tab-btn" onclick="App.navigateToTab('takeoff')"><i class="fas fa-ruler-combined"></i> Takeoff</button>
                <button class="tab-btn" onclick="App.navigateToTab('database')"><i class="fas fa-database"></i> Database</button>
                <button class="tab-btn" onclick="App.navigateToTab('estimate')"><i class="fas fa-clipboard-list"></i> Estimate</button>
            </nav>
        </aside>

        <main class="content-area">
            <div id="dashboard-page" class="page active">
                <h2>Dashboard</h2>
                <div class="card stats-grid">
                    <div class="stat-card"><div class="value">5</div><div class="label">Active Projects</div></div>
                    <div class="stat-card"><div class="value">12</div><div class="label">Completed Takeoffs</div></div>
                    <div class="stat-card"><div class="value">$1.2M</div><div class="label">Total Estimated</div></div>
                </div>
                <div class="card"><h3 class="card-header">Recent Estimates</h3></div>
            </div>

            <div id="takeoff-page" class="page">
                <div class="takeoff-main-panel">
                    <div class="takeoff-toolbar">
                        <input type="file" id="pdf-upload" style="display: none;" onchange="App.loadPdf(event)">
                        <button class="toolbar-btn" title="Open PDF" onclick="document.getElementById('pdf-upload').click()"><i class="fas fa-folder-open"></i></button>
                        <button id="tool-linear" class="toolbar-btn" title="Linear Takeoff" onclick="App.setTakeoffMode('linear')"><i class="fas fa-ruler-horizontal"></i></button>
                        <button id="tool-area" class="toolbar-btn" title="Area Takeoff" onclick="App.setTakeoffMode('area')"><i class="fas fa-vector-square"></i></button>
                        <button id="tool-count" class="toolbar-btn" title="Count Takeoff" onclick="App.setTakeoffMode('count')"><i class="fas fa-list-ol"></i></button>
                    </div>
                    <div class="takeoff-viewer" id="takeoff-viewer">
                         <div id="pdf-canvas-container">
                             <canvas id="pdf-canvas"></canvas>
                             <canvas id="draw-canvas"></canvas>
                         </div>
                    </div>
                </div>
                <div class="takeoff-sidebar">
                    <div id="pending-takeoff">
                        <i class="fas fa-info-circle"></i>
                        <p>Pending Takeoff: <strong id="pending-takeoff-qty"></strong></p>
                        <small>Go to the Database tab to select a cost item.</small>
                    </div>
                    <h3><i class="fas fa-history"></i> Takeoff Log</h3>
                    <div class="takeoff-log" id="takeoff-log-items">
                        <p style="color: var(--text-muted); padding: 10px;">Perform a takeoff to see results.</p>
                    </div>
                </div>
            </div>

            <div id="database-page" class="page">
                <h2>RSMeans Data Catalog</h2>
                <div class="card">
                     <div class="form-group">
                        <label for="cost-item-search">Search Cost Items</label>
                        <input type="text" id="cost-item-search" class="form-input" placeholder="e.g., 'Concrete 3000 psi'" onkeyup="App.renderDatabaseTable()">
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="data-table" id="database-table">
                        <thead><tr><th>Code</th><th>Description</th><th>Unit</th><th>Cost</th><th></th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="estimate-page" class="page">
                <h2>Current Estimate</h2>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Desc</th><th>Qty</th><th>Unit</th>
                                <th>Mat.</th><th>Labor</th><th>Equip.</th>
                                <th>Total</th><th></th>
                            </tr>
                        </thead>
                        <tbody id="estimate-tbody"></tbody>
                    </table>
                </div>
                <h3 style="text-align: right; margin-top: 20px;">Total: <span id="estimate-total">$0.00</span></h3>
            </div>
        </main>
    </div>

<script>
const App = {
    // --- App State & Config ---
    pdfDoc: null, pageNum: 1, scale: 1.5,
    pdfCanvas: null, pdfCtx: null, drawCanvas: null, drawCtx: null,
    takeoffMode: null, isDrawing: false, currentPoints: [],
    pendingTakeoff: null,
    
    // --- Mock Data ---
    rsMeansData: {
        "03": { name: "Concrete", items: {
            "033000": { description: "Cast-in-Place Concrete, 3000 psi", unit: "CY", material: 160, labor: 50, equipment: 25 },
            "033053": { description: "Slab on Grade, 4\" thick", unit: "SF", material: 3.75, labor: 2.50, equipment: 0.50 },
        }},
        "04": { name: "Masonry", items: {
            "042200": { description: "CMU Block Wall, 8x8x16", unit: "SF", material: 5, labor: 9, equipment: 1 },
        }},
        "09": { name: "Finishes", items: {
            "092900": { description: "Gypsum Board Wall", unit: "SF", material: 0.90, labor: 2.50, equipment: 0.25 },
        }}
    },

    // --- Initialization ---
    init: function() {
        this.pdfCanvas = document.getElementById('pdf-canvas');
        if (this.pdfCanvas) this.pdfCtx = this.pdfCanvas.getContext('2d');
        this.drawCanvas = document.getElementById('draw-canvas');
        if (this.drawCanvas) {
            this.drawCtx = this.drawCanvas.getContext('2d');
            this.drawCanvas.addEventListener('click', (e) => this.handleCanvasClick(e));
            this.drawCanvas.addEventListener('mousemove', (e) => this.handleCanvasMouseMove(e));
            this.drawCanvas.addEventListener('dblclick', (e) => this.handleCanvasDblClick(e));
        }
        this.renderDatabaseTable();
    },

    // --- UI & Theme ---
    toggleTheme: function() { document.body.classList.toggle('night-mode'); },
    navigateToTab: function(pageName) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`${pageName}-page`).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick="App.navigateToTab('${pageName}')"]`).classList.add('active');
    },
    
    // --- PDF & Canvas Logic ---
    loadPdf: function(event) {
        const file = event.target.files[0];
        if (!file || file.type !== 'application/pdf') return alert('Please select a PDF file.');
        const fileReader = new FileReader();
        fileReader.onload = (e) => {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
            pdfjsLib.getDocument({ data: e.target.result }).promise.then(pdfDoc => {
                this.pdfDoc = pdfDoc;
                this.renderPage(this.pageNum);
            });
        };
        fileReader.readAsArrayBuffer(file);
    },
    renderPage: function(num) {
        if (!this.pdfDoc) return;
        this.pdfDoc.getPage(num).then((page) => {
            const viewport = page.getViewport({ scale: this.scale });
            this.pdfCanvas.height = viewport.height; this.pdfCanvas.width = viewport.width;
            this.drawCanvas.height = viewport.height; this.drawCanvas.width = viewport.width;
            page.render({ canvasContext: this.pdfCtx, viewport: viewport });
        });
    },

    // --- Takeoff & Drawing Logic ---
    setTakeoffMode: function(mode) {
        this.takeoffMode = this.takeoffMode === mode ? null : mode;
        this.isDrawing = false; this.currentPoints = []; this.clearDrawing();
        document.querySelectorAll('.toolbar-btn').forEach(btn => btn.classList.remove('active'));
        if (this.takeoffMode) document.getElementById(`tool-${mode}`).classList.add('active');
    },
    handleCanvasClick: function(event) {
        if (!this.takeoffMode) return;
        const rect = this.drawCanvas.getBoundingClientRect();
        const x = event.clientX - rect.left; const y = event.clientY - rect.top;
        if (this.takeoffMode === 'count') {
            this.drawCount(x, y); this.logTakeoff('Count', 1, 'EA');
            return;
        }
        this.isDrawing = true; this.currentPoints.push({ x, y }); this.drawCurrentTakeoff();
    },
    handleCanvasMouseMove: function(event) {
        if (!this.isDrawing || this.currentPoints.length === 0) return;
        const rect = this.drawCanvas.getBoundingClientRect();
        const x = event.clientX - rect.left; const y = event.clientY - rect.top;
        this.drawCurrentTakeoff({ x, y });
    },
    handleCanvasDblClick: function(event) {
        if (!this.isDrawing || this.currentPoints.length < 2) return;
        this.finishTakeoff();
    },
    finishTakeoff: function() {
        let quantity = 0, unit = '', desc = '';
        if (this.takeoffMode === 'linear') {
            for (let i = 0; i < this.currentPoints.length - 1; i++) {
                quantity += Math.sqrt(Math.pow(this.currentPoints[i+1].x - this.currentPoints[i].x, 2) + Math.pow(this.currentPoints[i+1].y - this.currentPoints[i].y, 2));
            }
            unit = 'px'; desc = 'Linear Takeoff';
        } else if (this.takeoffMode === 'area') {
            let area = 0;
            for (let i = 0; i < this.currentPoints.length; i++) {
                const j = (i + 1) % this.currentPoints.length;
                area += this.currentPoints[i].x * this.currentPoints[j].y;
                area -= this.currentPoints[j].x * this.currentPoints[i].y;
            }
            quantity = Math.abs(area / 2); unit = 'pxÂ²'; desc = 'Area Takeoff';
        }
        this.logTakeoff(desc, quantity, unit);
        this.currentPoints = []; this.isDrawing = false;
    },
    clearDrawing: function() { this.drawCtx.clearRect(0, 0, this.drawCanvas.width, this.drawCanvas.height); },
    drawCurrentTakeoff: function(mousePos = null) {
        this.clearDrawing();
        if (this.currentPoints.length === 0) return;
        this.drawCtx.beginPath();
        this.drawCtx.moveTo(this.currentPoints[0].x, this.currentPoints[0].y);
        this.currentPoints.forEach(p => this.drawCtx.lineTo(p.x, p.y));
        if (mousePos) this.drawCtx.lineTo(mousePos.x, mousePos.y);
        if (this.takeoffMode === 'area' && this.currentPoints.length > 1) {
             this.drawCtx.closePath(); this.drawCtx.fillStyle = 'rgba(25, 135, 84, 0.4)'; this.drawCtx.fill();
        }
        this.drawCtx.strokeStyle = this.takeoffMode === 'linear' ? '#ffc107' : '#198754';
        this.drawCtx.lineWidth = 3; this.drawCtx.stroke();
    },
    drawCount: function(x, y) {
        this.drawCtx.font = "20px FontAwesome"; this.drawCtx.fillStyle = '#dc3545';
        this.drawCtx.fillText('\uf140', x - 10, y + 10);
    },

    // --- Log & Estimate Linking ---
    logTakeoff: function(desc, qty, unit) {
        const logContainer = document.getElementById('takeoff-log-items');
        if (logContainer.querySelector('p')) logContainer.innerHTML = '';
        
        const logItem = document.createElement('div');
        logItem.className = 'log-item';
        const icon = this.takeoffMode === 'linear' ? 'fa-ruler-horizontal' : this.takeoffMode === 'area' ? 'fa-vector-square' : 'fa-list-ol';
        const iconColor = this.takeoffMode === 'linear' ? '#ffc107' : this.takeoffMode === 'area' ? '#198754' : '#dc3545';
        
        logItem.innerHTML = `
            <div class="desc"><i class="fas ${icon}" style="color:${iconColor}"></i> ${desc}</div>
            <div class="qty">${qty.toFixed(2)} ${unit}</div>
            <button title="Send to Estimate" class="btn" style="padding: 5px 10px;" onclick="App.prepareToSendToEstimate(${qty},'${unit}')"><i class="fas fa-arrow-right"></i></button>`;
        
        logContainer.prepend(logItem);
    },
    prepareToSendToEstimate: function(qty, unit) {
        this.pendingTakeoff = { qty, unit };
        const pendingDiv = document.getElementById('pending-takeoff');
        document.getElementById('pending-takeoff-qty').textContent = `${qty.toFixed(2)} ${unit}`;
        pendingDiv.style.display = 'block';
        this.navigateToTab('database');
    },
    findCostItem: function(code) {
        for (const div in this.rsMeansData) {
            if (this.rsMeansData[div].items[code]) return this.rsMeansData[div].items[code];
        }
        return null;
    },
    addCopyToEstimate: function(itemCode) {
        const item = this.findCostItem(itemCode);
        if (!item) return;

        let qty = this.pendingTakeoff ? this.pendingTakeoff.qty : 1.00;

        const tbody = document.getElementById('estimate-tbody');
        const newRow = tbody.insertRow();
        const total = (item.material + item.labor + item.equipment) * qty;

        newRow.innerHTML = `
            <td>${item.description}</td>
            <td><input type="number" value="${qty.toFixed(2)}" class="form-input qty-input" onchange="App.updateRowCost(this)" style="width:100px;padding:5px;"></td>
            <td>${item.unit}</td>
            <td data-mat="${item.material}">${(item.material * qty).toFixed(2)}</td>
            <td data-labor="${item.labor}">${(item.labor * qty).toFixed(2)}</td>
            <td data-equip="${item.equipment}">${(item.equipment * qty).toFixed(2)}</td>
            <td class="total-cost-cell">${total.toFixed(2)}</td>
            <td><button class="btn" style="padding: 5px 10px; background-color: var(--takeoff-count-color);" onclick="App.removeEstimateRow(this)"><i class="fas fa-trash"></i></button></td>`;
        
        this.updateEstimateTotal();
        this.navigateToTab('estimate');
        
        // Clear pending takeoff
        this.pendingTakeoff = null;
        document.getElementById('pending-takeoff').style.display = 'none';
    },
    updateRowCost: function(qtyInput) {
        const row = qtyInput.closest('tr');
        const qty = parseFloat(qtyInput.value) || 0;
        const matUnit = parseFloat(row.querySelector('[data-mat]').dataset.mat) || 0;
        const laborUnit = parseFloat(row.querySelector('[data-labor]').dataset.labor) || 0;
        const equipUnit = parseFloat(row.querySelector('[data-equip]').dataset.equip) || 0;

        const matCell = row.querySelector('[data-mat]');
        const laborCell = row.querySelector('[data-labor]');
        const equipCell = row.querySelector('[data-equip]');
        const totalCell = row.querySelector('.total-cost-cell');
        
        matCell.textContent = (matUnit * qty).toFixed(2);
        laborCell.textContent = (laborUnit * qty).toFixed(2);
        equipCell.textContent = (equipUnit * qty).toFixed(2);
        totalCell.textContent = ((matUnit + laborUnit + equipUnit) * qty).toFixed(2);
        
        this.updateEstimateTotal();
    },
    updateEstimateTotal: function() {
        let total = 0;
        document.querySelectorAll('#estimate-tbody .total-cost-cell').forEach(cell => {
            total += parseFloat(cell.textContent) || 0;
        });
        document.getElementById('estimate-total').textContent = `$${total.toFixed(2)}`;
    },
    removeEstimateRow: function(button) {
        button.closest('tr').remove();
        this.updateEstimateTotal();
    },

    // --- Database Tab ---
    renderDatabaseTable: function() {
        const tbody = document.querySelector('#database-table tbody');
        if (!tbody) return;
        
        const searchTerm = document.getElementById('cost-item-search').value.toLowerCase();
        tbody.innerHTML = '';
        
        for (const divCode in this.rsMeansData) {
            const division = this.rsMeansData[divCode];
            for (const itemCode in division.items) {
                const item = division.items[itemCode];
                if (item.description.toLowerCase().includes(searchTerm)) {
                     const totalCost = item.material + item.labor + item.equipment;
                     const row = tbody.insertRow();
                     row.innerHTML = `
                        <td>${divCode}-${itemCode}</td>
                        <td>${item.description}</td>
                        <td>${item.unit}</td>
                        <td>$${totalCost.toFixed(2)}</td>
                        <td><button class="btn" style="padding: 5px 10px;" onclick="App.addCopyToEstimate('${itemCode}')">Add</button></td>
                     `;
                }
            }
        }
    }
};

document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
