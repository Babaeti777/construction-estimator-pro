<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construction Estimator Pro - Redesigned</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS for base styles and theming */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #718096;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Animation for custom modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-fade-in {
            animation: fadeIn 0.2s ease-out;
        }
        
        /* Animation for spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
    <script>
        // Tailwind CSS dark mode configuration
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- Custom Modal for Confirmations -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 w-full max-w-md mx-4 modal-fade-in">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 text-gray-900 dark:text-white">Confirmation</h3>
            <p id="modalMessage" class="text-gray-600 dark:text-gray-300 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-4">
                <button id="modalCancel" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">Cancel</button>
                <button id="modalConfirm" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- GitHub Authentication Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-lg mx-4 modal-fade-in">
            <h3 class="text-2xl font-bold mb-2 text-center text-gray-900 dark:text-white">üîó GitHub Integration</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-6 text-center">To save and sync your projects, please provide your GitHub credentials.</p>
            
            <div class="space-y-4">
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">GitHub Username</label>
                    <input type="text" id="githubUsername" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="your-username">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Personal Access Token</label>
                    <input type="password" id="githubToken" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="ghp_...">
                </div>
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Repository Name</label>
                    <input type="text" id="githubRepo" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500" value="construction-projects">
                </div>
            </div>

            <div class="flex items-center justify-center space-x-4 mt-8">
                <button id="connectGitHubBtn" class="flex items-center justify-center gap-2 w-full px-4 py-2.5 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-all">
                    <span>üîó</span>
                    <span>Connect GitHub</span>
                </button>
                <button id="skipGitHubBtn" class="flex items-center justify-center gap-2 w-full px-4 py-2.5 rounded-lg bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition-all">
                    <span>‚è≠Ô∏è</span>
                    <span>Skip</span>
                </button>
            </div>

            <div class="mt-6 text-xs text-gray-500 dark:text-gray-400 text-center">
                Need help? <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens" target="_blank" class="text-blue-500 hover:underline">Learn how to create a token</a> with `repo` scope.
            </div>
        </div>
    </div>


    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 dark:text-white">Construction Estimator Pro</h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">A Modern, Cloud-Synced Cost Estimation Tool</p>
        </header>

        <main class="space-y-6">
            <!-- Control Panel Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        
                        <!-- Project Management -->
                        <div class="space-y-4 md:col-span-2 lg:col-span-1">
                            <h3 class="text-lg font-bold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-2">üìÇ Project Manager</h3>
                            <div class="flex items-center gap-2">
                                <select id="projectSelector" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500"></select>
                                <button id="newProjectBtn" title="New Project" class="flex-shrink-0 p-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">‚ûï</button>
                                <button id="deleteProjectBtn" title="Delete Project" class="flex-shrink-0 p-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition">üóëÔ∏è</button>
                            </div>
                            <div class="flex items-center gap-2">
                                 <button id="loadProjectFileBtn" class="flex-grow flex items-center justify-center gap-2 w-full px-3 py-2 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition text-sm">
                                    <span>üì§</span>
                                    <span>Load File</span>
                                </button>
                                <button id="downloadProjectBtn" class="flex-grow flex items-center justify-center gap-2 w-full px-3 py-2 rounded-md bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 transition text-sm">
                                    <span>üì•</span>
                                    <span>Download</span>
                                </button>
                                <input type="file" id="fileInput" accept=".json" class="hidden">
                            </div>
                             <div id="githubStatus" class="p-3 rounded-md text-sm text-center font-medium"></div>
                        </div>

                        <!-- Project Settings -->
                        <div class="space-y-4 md:col-span-2">
                             <h3 class="text-lg font-bold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-2">‚öôÔ∏è Project Settings</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                               <div class="form-group">
                                    <label for="projectName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Project Name</label>
                                    <input type="text" id="projectName" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="My New Project">
                                </div>
                                <div class="form-group">
                                    <label for="regionFactor" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Region</label>
                                    <select id="regionFactor" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                        <option value="1.00">National Average</option>
                                        <option value="0.80">Southeast (-20%)</option>
                                        <option value="0.90">Midwest (-10%)</option>
                                        <option value="1.10">Northeast (+10%)</option>
                                        <option value="1.25">West Coast (+25%)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="taxRate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tax Rate (%)</label>
                                    <input type="number" id="taxRate" value="8.25" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="form-group">
                                    <label for="contingency" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Contingency (%)</label>
                                    <input type="number" id="contingency" value="10" class="w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div class="form-group flex flex-col justify-between">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Theme</label>
                                    <div class="flex items-center space-x-2 bg-gray-50 dark:bg-gray-700 rounded-md p-2">
                                        <span>‚òÄÔ∏è</span>
                                        <label for="darkModeToggle" class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-500 peer-checked:bg-blue-600"></div>
                                        </label>
                                        <span>üåô</span>
                                    </div>
                                </div>
                                <div class="form-group flex items-end">
                                    <button id="connectGitHubMainBtn" class="flex items-center justify-center gap-2 w-full px-3 py-2 rounded-md bg-gray-700 text-white font-semibold hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 transition text-sm">
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Cost Items Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
                <div class="p-6">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 border-b border-gray-200 dark:border-gray-700 pb-4">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white">üìã Cost Items</h3>
                        <div class="flex items-center gap-2 mt-4 sm:mt-0">
                           <button id="addItemBtn" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition text-sm font-semibold">
                                <span>‚ûï</span>
                                <span>Add Item</span>
                            </button>
                             <button id="resetEstimateBtn" class="flex items-center gap-2 px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition text-sm font-semibold">
                                <span>üîÑ</span>
                                <span>Reset Items</span>
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                <tr>
                                    <th scope="col" class="px-4 py-3 min-w-[200px]">Item</th>
                                    <th scope="col" class="px-4 py-3">Category</th>
                                    <th scope="col" class="px-4 py-3">Qty</th>
                                    <th scope="col" class="px-4 py-3">Unit</th>
                                    <th scope="col" class="px-4 py-3">Unit Price</th>
                                    <th scope="col" class="px-4 py-3">Markup %</th>
                                    <th scope="col" class="px-4 py-3 text-right">Final Cost</th>
                                    <th scope="col" class="px-4 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Summary & Analysis Card -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden">
                <div class="p-6">
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 border-b border-gray-200 dark:border-gray-700 pb-4">üìä Summary & Analysis</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Cost Breakdown -->
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4 text-center">
                               <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                    <div id="itemCount" class="text-2xl font-bold text-gray-900 dark:text-white">0</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Total Items</div>
                                </div>
                                <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                    <div id="avgLineCost" class="text-2xl font-bold text-gray-900 dark:text-white">$0.00</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Avg. Item Cost</div>
                                </div>
                            </div>
                             <div class="space-y-2 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                                <div class="flex justify-between font-medium">
                                    <span>Subtotal</span>
                                    <span id="subtotal">$0.00</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                                    <span>Tax</span>
                                    <span id="taxAmount">$0.00</span>
                                </div>
                                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400">
                                    <span>Contingency</span>
                                    <span id="contingencyAmount">$0.00</span>
                                </div>
                                <hr class="border-gray-300 dark:border-gray-600 my-2">
                                <div class="flex justify-between font-bold text-xl text-blue-600 dark:text-blue-400">
                                    <span>Grand Total</span>
                                    <span id="grandTotal">$0.00</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="saveEstimateBtn" class="flex-grow flex items-center justify-center gap-2 w-full px-4 py-2.5 rounded-md bg-blue-600 text-white font-semibold hover:bg-blue-700 transition text-sm">
                                    <span>üíæ</span>
                                    <span>Save Project</span>
                                </button>
                                <button id="exportCsvBtn" class="flex-grow flex items-center justify-center gap-2 w-full px-4 py-2.5 rounded-md bg-green-600 text-white font-semibold hover:bg-green-700 transition text-sm">
                                    <span>üìà</span>
                                    <span>Export CSV</span>
                                </button>
                            </div>
                        </div>

                        <!-- Chart -->
                        <div class="relative h-64 md:h-auto min-h-[300px] p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg">
                            <canvas id="costChart"></canvas>
                        </div>

                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
    // --- DATABASE --- //
    // Comprehensive 2024-2025 Construction Cost Database
    const priceDatabase = [
        // ... (The database is large, keeping it collapsed for brevity)
        { category: "Material", item: "Concrete (Ready Mix)", unit: "cubic yard", price: 166 }, { category: "Material", item: "Structural Steel", unit: "ton", price: 1650 }, { category: "Material", item: "Framing Lumber 2x4", unit: "linear foot", price: 1.65 }, { category: "Material", item: "Drywall 1/2\"", unit: "sheet", price: 16.80 }, { category: "Material", item: "Fiberglass Batts R-15", unit: "sq ft", price: 0.95 }, { category: "Material", item: "Asphalt Shingles", unit: "sq ft", price: 3.75 }, { category: "Material", item: "Vinyl Siding", unit: "sq ft", price: 5.25 }, { category: "Material", item: "Windows (Standard)", unit: "each", price: 485 }, { category: "Sustainable", item: "Cross-Laminated Timber (CLT)", unit: "cubic meter", price: 650 }, { category: "Labor", item: "Carpenter (Skilled)", unit: "hour", price: 29.50 }, { category: "Labor", item: "Electrician (Journeyman)", unit: "hour", price: 34.50 }, { category: "Labor", item: "Plumber (Journeyman)", unit: "hour", price: 34.75 }, { category: "Labor", item: "Project Manager", unit: "hour", price: 65.00 }, { category: "Equipment", item: "Excavator (Mini <8k lbs)", unit: "day", price: 285 }, { category: "Tech Equipment", item: "Construction Drone", unit: "day", price: 485 }, { category: "HVAC", item: "Central AC Unit (3-ton)", unit: "each", price: 4850 }, { category: "Solar", item: "Solar Panel Installation", unit: "watt", price: 2.50 }, { category: "Subcontractor", item: "Framing", unit: "sq ft", price: 9.00 }, { category: "Site Work", item: "Excavation", unit: "cubic yard", price: 15.50 }
    ];

    // --- GITHUB MANAGER --- //
    class GitHubManager {
        constructor() {
            this.username = null; this.token = null; this.repo = null; this.isConnected = false; this.baseUrl = 'https://api.github.com';
        }
        async connect(username, token, repo) {
            this.username = username; this.token = token; this.repo = repo;
            try {
                const response = await fetch(`${this.baseUrl}/user`, { headers: { 'Authorization': `token ${token}` } });
                if (response.ok) {
                    await this.ensureRepository();
                    this.isConnected = true; this.saveCredentials(); return true;
                } else { throw new Error('Invalid credentials'); }
            } catch (error) { console.error('GitHub connection failed:', error); return false; }
        }
        async ensureRepository() {
            try {
                const response = await fetch(`${this.baseUrl}/repos/${this.username}/${this.repo}`, { headers: { 'Authorization': `token ${this.token}` } });
                if (response.status === 404) {
                    await fetch(`${this.baseUrl}/user/repos`, { method: 'POST', headers: { 'Authorization': `token ${this.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ name: this.repo, description: 'Construction Estimator Pro Projects', private: true, auto_init: true }) });
                }
            } catch (error) { console.error('Error ensuring repository:', error); }
        }
        saveCredentials() { localStorage.setItem('github_credentials', JSON.stringify({ username: this.username, token: this.token, repo: this.repo })); }
        loadCredentials() {
            const saved = localStorage.getItem('github_credentials');
            if (saved) {
                const creds = JSON.parse(saved);
                this.username = creds.username; this.token = creds.token; this.repo = creds.repo; this.isConnected = true;
                return true;
            }
            return false;
        }
        disconnect() { this.username = null; this.token = null; this.repo = null; this.isConnected = false; localStorage.removeItem('github_credentials'); }
        async saveProject(projectId, projectData) {
            if (!this.isConnected) return false;
            try {
                const fileName = `project_${projectId}.json`;
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(projectData, null, 2))));
                let sha = null;
                try {
                    const res = await fetch(`${this.baseUrl}/repos/${this.username}/${this.repo}/contents/${fileName}`, { headers: { 'Authorization': `token ${this.token}` } });
                    if (res.ok) sha = (await res.json()).sha;
                } catch (e) { /* File doesn't exist */ }
                const payload = { message: `Update project: ${projectData.name}`, content, sha };
                const response = await fetch(`${this.baseUrl}/repos/${this.username}/${this.repo}/contents/${fileName}`, { method: 'PUT', headers: { 'Authorization': `token ${this.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                return response.ok;
            } catch (error) { console.error('Error saving to GitHub:', error); return false; }
        }
        async loadProjects() {
            if (!this.isConnected) return {};
            try {
                const response = await fetch(`${this.baseUrl}/repos/${this.username}/${this.repo}/contents/`, { headers: { 'Authorization': `token ${this.token}` } });
                if (!response.ok) return {};
                const files = await response.json();
                const projects = {};
                for (const file of files.filter(f => f.name.startsWith('project_') && f.name.endsWith('.json'))) {
                    try {
                        const fileRes = await fetch(file.download_url);
                        const projectData = await fileRes.json();
                        projects[projectData.id] = projectData;
                    } catch (e) { console.error(`Error loading project ${file.name}:`, e); }
                }
                return projects;
            } catch (error) { console.error('Error loading projects from GitHub:', error); return {}; }
        }
        async deleteProject(projectId) {
            if (!this.isConnected) return false;
            try {
                const fileName = `project_${projectId}.json`;
                const res = await fetch(`${this.baseUrl}/repos/${this.username}/${this.repo}/contents/${fileName}`, { headers: { 'Authorization': `token ${this.token}` } });
                if (!res.ok) return false;
                const file = await res.json();
                const delRes = await fetch(`${this.baseUrl}/repos/${this.username}/${this.repo}/contents/${fileName}`, { method: 'DELETE', headers: { 'Authorization': `token ${this.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: `Delete project: ${projectId}`, sha: file.sha }) });
                return delRes.ok;
            } catch (error) { console.error('Error deleting from GitHub:', error); return false; }
        }
    }

    // --- GLOBAL STATE & UTILS --- //
    let costChart = null;
    let projects = {};
    let currentProjectId = null;
    const githubManager = new GitHubManager();

    const debounce = (func, wait) => {
        let timeout;
        return (...args) => {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    };

    // --- CUSTOM MODAL --- //
    const showConfirmation = (title, message) => {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;
        document.getElementById('customModal').classList.remove('hidden');

        return new Promise((resolve) => {
            document.getElementById('modalConfirm').onclick = () => {
                document.getElementById('customModal').classList.add('hidden');
                resolve(true);
            };
            document.getElementById('modalCancel').onclick = () => {
                document.getElementById('customModal').classList.add('hidden');
                resolve(false);
            };
        });
    };

    // --- INITIALIZATION & UI --- //
    const initApp = async () => {
        setupEventListeners();
        loadLocalProjects(); // Load local first for speed
        if (githubManager.loadCredentials()) {
            await updateGitHubStatus(true); // Attempt auto-connect
            await syncProjectsFromGitHub();
        } else {
            showAuthModal();
        }

        if (Object.keys(projects).length === 0) {
            createNewProject('My First Project');
        } else if (!currentProjectId) {
            currentProjectId = localStorage.getItem('currentProjectId') || Object.keys(projects)[0];
            if (!projects[currentProjectId]) {
                currentProjectId = Object.keys(projects)[0];
            }
        }
        
        updateProjectSelector();
        loadCurrentProject();
    };

    const showAuthModal = () => document.getElementById('authModal').classList.remove('hidden');
    const hideAuthModal = () => document.getElementById('authModal').classList.add('hidden');

    const updateGitHubStatus = async (tryConnect = false) => {
        const statusEl = document.getElementById('githubStatus');
        const connectBtn = document.getElementById('connectGitHubMainBtn');
        
        if (tryConnect && githubManager.token) {
            const success = await githubManager.connect(githubManager.username, githubManager.token, githubManager.repo);
            githubManager.isConnected = success;
        }

        if (githubManager.isConnected) {
            statusEl.className = 'p-3 rounded-md text-sm text-center font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
            statusEl.innerHTML = `‚úÖ Connected to ${githubManager.repo}`;
            connectBtn.innerHTML = `<span>üîÑ</span><span>Sync/Reconnect</span>`;
        } else {
            statusEl.className = 'p-3 rounded-md text-sm text-center font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
            statusEl.innerHTML = `‚ùå Disconnected. Data is local.`;
            connectBtn.innerHTML = `<span>üîó</span><span>Connect GitHub</span>`;
        }
    };
    
    const showTemporaryStatus = (element, message, success = true, duration = 3000) => {
        const originalHTML = element.innerHTML;
        const originalClasses = element.className;
        element.disabled = true;

        element.className = `${originalClasses.split(' ').filter(c => !c.startsWith('bg-')).join(' ')} ${success ? 'bg-green-600' : 'bg-red-600'}`;
        element.innerHTML = `<span>${success ? '‚úÖ' : '‚ùå'}</span><span>${message}</span>`;
        
        setTimeout(() => {
            element.innerHTML = originalHTML;
            element.className = originalClasses;
            element.disabled = false;
        }, duration);
    };

    // --- PROJECT MANAGEMENT --- //
    const loadLocalProjects = () => {
        const localData = localStorage.getItem('projects');
        if (localData) {
            projects = JSON.parse(localData);
        }
    };
    
    const saveAllProjectsLocally = () => {
        localStorage.setItem('projects', JSON.stringify(projects));
        if(currentProjectId) localStorage.setItem('currentProjectId', currentProjectId);
    };

    const syncProjectsFromGitHub = async () => {
        if (!githubManager.isConnected) return;
        const statusEl = document.getElementById('githubStatus');
        statusEl.innerHTML = `<span class="spinner w-4 h-4 inline-block border-2 border-transparent border-t-current rounded-full"></span> Syncing...`;

        try {
            const githubProjects = await githubManager.loadProjects();
            // Merge projects, GitHub is the source of truth
            projects = { ...projects, ...githubProjects }; 
            
            if (Object.keys(githubProjects).length > 0) {
                 showTemporaryStatus(document.getElementById('connectGitHubMainBtn'), 'Sync Complete', true, 2000);
            }
            saveAllProjectsLocally();
            updateProjectSelector();
            loadCurrentProject(); // Reload to reflect changes
        } catch (e) {
            console.error(e);
        } finally {
            updateGitHubStatus();
        }
    };
    
    const createNewProject = (name) => {
        const projectId = 'proj_' + Date.now();
        projects[projectId] = {
            id: projectId, name: name, projectName: name,
            regionFactor: '1.00', taxRate: '8.25', contingency: '10',
            darkMode: document.body.classList.contains('dark'),
            timestamp: new Date().toISOString(), rows: []
        };
        currentProjectId = projectId;
        saveAllProjectsLocally();
        return projectId;
    };
    
    const handleNewProject = async () => {
        const name = prompt('Enter new project name:', 'New Project ' + (Object.keys(projects).length + 1));
        if (name) {
            await saveCurrentProject();
            createNewProject(name);
            updateProjectSelector();
            loadCurrentProject();
        }
    };
    
    const handleDeleteProject = async () => {
        if (!currentProjectId || Object.keys(projects).length <= 1) {
            alert('Cannot delete the last project.');
            return;
        }
        const confirmed = await showConfirmation('Delete Project', `Are you sure you want to delete "${projects[currentProjectId].name}"? This action cannot be undone.`);
        if (confirmed) {
            if (githubManager.isConnected) {
                await githubManager.deleteProject(currentProjectId);
            }
            delete projects[currentProjectId];
            currentProjectId = Object.keys(projects)[0];
            saveAllProjectsLocally();
            updateProjectSelector();
            loadCurrentProject();
        }
    };
    
    const updateProjectSelector = () => {
        const selector = document.getElementById('projectSelector');
        selector.innerHTML = '';
        Object.values(projects).sort((a,b) => (a.name > b.name) ? 1 : -1).forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            selector.appendChild(option);
        });
        selector.value = currentProjectId;
    };

    const handleProjectChange = async (event) => {
        await saveCurrentProject();
        currentProjectId = event.target.value;
        localStorage.setItem('currentProjectId', currentProjectId);
        loadCurrentProject();
    };

    const saveCurrentProject = async (showFeedback = false) => {
        if (!currentProjectId) return;

        const projectData = {
            ...projects[currentProjectId],
            name: document.getElementById('projectName').value,
            projectName: document.getElementById('projectName').value,
            regionFactor: document.getElementById('regionFactor').value,
            taxRate: document.getElementById('taxRate').value,
            contingency: document.getElementById('contingency').value,
            darkMode: document.getElementById('darkModeToggle').checked,
            timestamp: new Date().toISOString(),
            rows: Array.from(document.querySelectorAll('#tableBody tr')).map(getRowData)
        };
        projects[currentProjectId] = projectData;
        saveAllProjectsLocally();
        
        if (githubManager.isConnected) {
            const success = await githubManager.saveProject(currentProjectId, projectData);
            if (showFeedback) {
                 showTemporaryStatus(document.getElementById('saveEstimateBtn'), success ? 'Saved to Cloud' : 'Save Failed', success);
            }
        } else if (showFeedback) {
             showTemporaryStatus(document.getElementById('saveEstimateBtn'), 'Saved Locally');
        }
    };
    
    const loadCurrentProject = () => {
        if (!currentProjectId || !projects[currentProjectId]) return;
        const project = projects[currentProjectId];

        document.getElementById('projectName').value = project.name || '';
        document.getElementById('regionFactor').value = project.regionFactor || '1.00';
        document.getElementById('taxRate').value = project.taxRate || '8.25';
        document.getElementById('contingency').value = project.contingency || '10';
        
        const darkModeToggle = document.getElementById('darkModeToggle');
        darkModeToggle.checked = project.darkMode || false;
        document.documentElement.classList.toggle('dark', darkModeToggle.checked);
        
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = '';
        if (project.rows && project.rows.length > 0) {
            project.rows.forEach(addRow);
        } else {
            addRow(); // Start with one empty row
        }
        updateSummary();
    };

    // --- FILE OPERATIONS --- //
    const downloadProject = async () => {
        if (!currentProjectId) return;
        await saveCurrentProject(); // Ensure latest data is saved
        const project = projects[currentProjectId];
        const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${project.name.replace(/[^a-z0-9]/gi, '_')}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    const loadProjectFile = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (data.id && data.rows) { // It's a single project file
                    const newId = 'proj_' + Date.now();
                    data.id = newId;
                    projects[newId] = data;
                    currentProjectId = newId;
                    saveAllProjectsLocally();
                    updateProjectSelector();
                    loadCurrentProject();
                    if (githubManager.isConnected) await githubManager.saveProject(newId, data);
                    alert('Project loaded successfully!');
                } else {
                    alert('Invalid project file format.');
                }
            } catch (error) {
                alert('Error loading file. Please ensure it is a valid JSON project file.');
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset file input
    };

    // --- EVENT LISTENERS --- //
    const setupEventListeners = () => {
        document.getElementById('darkModeToggle').addEventListener('change', async (e) => {
            document.documentElement.classList.toggle('dark', e.target.checked);
            if(costChart) updateChart();
            await saveCurrentProject();
        });
        
        document.getElementById('projectSelector').addEventListener('change', handleProjectChange);
        document.getElementById('newProjectBtn').addEventListener('click', handleNewProject);
        document.getElementById('deleteProjectBtn').addEventListener('click', handleDeleteProject);

        // GitHub Modal
        document.getElementById('connectGitHubBtn').addEventListener('click', handleGitHubConnect);
        document.getElementById('skipGitHubBtn').addEventListener('click', hideAuthModal);
        document.getElementById('connectGitHubMainBtn').addEventListener('click', async () => {
             if (githubManager.isConnected) {
                await syncProjectsFromGitHub();
            } else {
                showAuthModal();
            }
        });
        
        // Settings & Actions
        ['regionFactor', 'taxRate', 'contingency', 'projectName'].forEach(id => {
            document.getElementById(id).addEventListener('input', debounce(async () => {
                recalculateAllRows();
                updateSummary();
                await saveCurrentProject();
            }, 500));
        });
        
        document.getElementById('addItemBtn').addEventListener('click', addRow);
        document.getElementById('resetEstimateBtn').addEventListener('click', handleReset);
        document.getElementById('saveEstimateBtn').addEventListener('click', () => saveCurrentProject(true));
        document.getElementById('exportCsvBtn').addEventListener('click', exportToCSV);
        
        // File I/O
        document.getElementById('downloadProjectBtn').addEventListener('click', downloadProject);
        document.getElementById('loadProjectFileBtn').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('fileInput').addEventListener('change', loadProjectFile);
    };

    const handleGitHubConnect = async () => {
        const username = document.getElementById('githubUsername').value.trim();
        const token = document.getElementById('githubToken').value.trim();
        const repo = document.getElementById('githubRepo').value.trim();
        if (!username || !token || !repo) {
            alert('Please fill in all GitHub fields.'); return;
        }

        const btn = document.getElementById('connectGitHubBtn');
        showTemporaryStatus(btn, 'Connecting...', true, 99999);

        const success = await githubManager.connect(username, token, repo);
        if (success) {
            hideAuthModal();
            updateGitHubStatus();
            await syncProjectsFromGitHub(); // Sync after connecting
            // Push all local projects to GitHub
            for (const [id, project] of Object.entries(projects)) {
                await githubManager.saveProject(id, project);
            }
        } else {
            alert('Failed to connect. Check token, username, and repo name.');
        }
        showTemporaryStatus(btn, 'Connect GitHub', true, 10); // Reset button
    };

    // --- TABLE & CALCULATIONS --- //
    const createItemSelect = (selectedItem = '') => {
        const select = document.createElement('select');
        select.className = 'w-full bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded-md p-1 focus:ring-blue-500 focus:border-blue-500 text-xs';
        select.innerHTML = '<option value="">-- Select Item --</option>';
        const categories = [...new Set(priceDatabase.map(item => item.category))];
        categories.forEach(category => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = category;
            priceDatabase.filter(item => item.category === category).forEach(item => {
                const option = document.createElement('option');
                option.value = item.item;
                option.textContent = `${item.item} (${item.unit})`;
                if (selectedItem === item.item) option.selected = true;
                optgroup.appendChild(option);
            });
            select.appendChild(optgroup);
        });
        select.addEventListener('change', e => updateRowFromSelect(e.target));
        return select;
    };

    const addRow = (savedData = {}) => {
        const tbody = document.getElementById('tableBody');
        const row = tbody.insertRow();
        row.className = 'bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';

        const createCell = (content, className = '') => {
            const cell = row.insertCell();
            cell.className = `px-4 py-2 ${className}`;
            if (typeof content === 'string') {
                cell.innerHTML = content;
            } else {
                cell.appendChild(content);
            }
            return cell;
        };
        const createInput = (type, value, handler) => {
            const input = document.createElement('input');
            input.type = type;
            input.value = value;
            input.min = '0';
            input.className = 'w-16 bg-gray-50 dark:bg-gray-900 border-gray-300 dark:border-gray-600 rounded-md p-1 focus:ring-blue-500 focus:border-blue-500 text-xs';
            input.addEventListener('input', debounce(e => handler(e.target), 300));
            return input;
        };

        createCell(createItemSelect(savedData.item || ''));
        createCell('', 'font-medium text-gray-900 dark:text-white'); // Category
        createCell(createInput('number', savedData.quantity || '1', updateRowCalculations));
        createCell(''); // Unit
        createCell(createInput('number', savedData.unitPrice || '0', updateRowCalculations));
        createCell(createInput('number', savedData.markup || '10', updateRowCalculations));
        createCell('$0.00', 'font-bold text-right'); // Final Cost
        
        const actionsCell = createCell('', 'text-center');
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.className = 'p-1 hover:text-red-500';
        deleteBtn.title = 'Delete Item';
        deleteBtn.onclick = async e => {
            if (document.querySelectorAll('#tableBody tr').length > 1) {
                e.target.closest('tr').remove();
                updateSummary();
                await saveCurrentProject();
            } else {
                alert("Cannot delete the last item. Reset the project instead.");
            }
        };
        actionsCell.appendChild(deleteBtn);

        if (savedData.item) {
            updateRowFromSelect(row.cells[0].querySelector('select'));
        }
    };

    const getRowData = (row) => ({
        item: row.cells[0].querySelector('select').value,
        category: row.cells[1].textContent,
        quantity: row.cells[2].querySelector('input').value,
        unit: row.cells[3].textContent,
        unitPrice: row.cells[4].querySelector('input').value,
        markup: row.cells[5].querySelector('input').value
    });

    const updateRowFromSelect = (select) => {
        const row = select.closest('tr');
        const itemData = priceDatabase.find(item => item.item === select.value);
        if (itemData) {
            row.cells[1].textContent = itemData.category;
            row.cells[3].textContent = itemData.unit;
            row.cells[4].querySelector('input').value = itemData.price;
        }
        updateRowCalculations(select);
    };

    const updateRowCalculations = (element) => {
        const row = element.closest('tr');
        const qty = parseFloat(row.cells[2].querySelector('input').value) || 0;
        const price = parseFloat(row.cells[4].querySelector('input').value) || 0;
        const markup = parseFloat(row.cells[5].querySelector('input').value) || 0;
        const regionFactor = parseFloat(document.getElementById('regionFactor').value) || 1;
        
        const finalCost = qty * price * (1 + markup / 100) * regionFactor;
        row.cells[6].textContent = `$${finalCost.toFixed(2)}`;
        
        updateSummary();
        saveCurrentProject(); // Auto-save on calculation changes
    };

    const recalculateAllRows = () => {
        document.querySelectorAll('#tableBody tr').forEach(row => updateRowCalculations(row.cells[0].querySelector('select')));
    };

    const updateSummary = () => {
        const rows = document.querySelectorAll('#tableBody tr');
        let subtotal = 0;
        let lineCosts = [];

        rows.forEach(row => {
            const cost = parseFloat(row.cells[6].textContent.replace('$', '')) || 0;
            subtotal += cost;
            lineCosts.push(cost);
        });

        const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
        const contingencyRate = parseFloat(document.getElementById('contingency').value) || 0;
        const taxAmount = subtotal * (taxRate / 100);
        const contingencyAmount = subtotal * (contingencyRate / 100);
        const grandTotal = subtotal + taxAmount + contingencyAmount;
        const avgLineCost = rows.length > 0 ? (subtotal / rows.length) : 0;

        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('taxAmount').textContent = `$${taxAmount.toFixed(2)}`;
        document.getElementById('contingencyAmount').textContent = `$${contingencyAmount.toFixed(2)}`;
        document.getElementById('grandTotal').textContent = `$${grandTotal.toFixed(2)}`;
        
        document.getElementById('itemCount').textContent = rows.length;
        document.getElementById('avgLineCost').textContent = `$${avgLineCost.toFixed(2)}`;

        updateChart();
    };

    const updateChart = () => {
        const categoryTotals = {};
        document.querySelectorAll('#tableBody tr').forEach(row => {
            const category = row.cells[1].textContent || 'Uncategorized';
            const cost = parseFloat(row.cells[6].textContent.replace('$', '')) || 0;
            categoryTotals[category] = (categoryTotals[category] || 0) + cost;
        });

        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);
        const isDark = document.documentElement.classList.contains('dark');

        const chartData = {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1', '#ec4899', '#6b7280'],
                borderColor: isDark ? '#1f2937' : '#ffffff',
                borderWidth: 2,
            }]
        };

        if (costChart) {
            costChart.data = chartData;
            costChart.options.plugins.legend.labels.color = isDark ? '#d1d5db' : '#4b5563';
            costChart.options.plugins.tooltip.backgroundColor = isDark ? 'rgba(31, 41, 55, 0.8)' : 'rgba(255, 255, 255, 0.8)';
            costChart.options.plugins.tooltip.titleColor = isDark ? '#f9fafb' : '#1f2937';
            costChart.options.plugins.tooltip.bodyColor = isDark ? '#d1d5db' : '#4b5563';
            costChart.update();
        } else {
            const ctx = document.getElementById('costChart').getContext('2d');
            costChart = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: isDark ? '#d1d5db' : '#4b5563', boxWidth: 12, padding: 15, font: { size: 12 } } },
                        tooltip: {
                            enabled: true, mode: 'index', intersect: false,
                            backgroundColor: isDark ? 'rgba(31, 41, 55, 0.8)' : 'rgba(255, 255, 255, 0.8)',
                            titleColor: isDark ? '#f9fafb' : '#1f2937', bodyColor: isDark ? '#d1d5db' : '#4b5563',
                            borderColor: isDark ? '#4b5563' : '#e5e7eb', borderWidth: 1,
                            callbacks: {
                                label: (context) => `${context.label}: $${context.parsed.toFixed(2)}`
                            }
                        }
                    }
                }
            });
        }
    };
    
    const handleReset = async () => {
        const confirmed = await showConfirmation('Reset Project', 'Are you sure you want to clear all items from the current project?');
        if (confirmed) {
            document.getElementById('tableBody').innerHTML = '';
            addRow();
            updateSummary();
            await saveCurrentProject();
        }
    };
    
    const exportToCSV = async () => {
        await saveCurrentProject();
        const project = projects[currentProjectId];
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += `Project Name,"${project.name}"\r\n`;
        csvContent += `Date,"${new Date().toLocaleDateString()}"\r\n\r\n`;
        csvContent += "Item,Category,Quantity,Unit,Unit Price,Markup %,Final Cost\r\n";
        
        project.rows.forEach(row => {
            const finalCost = (parseFloat(row.quantity) || 0) * (parseFloat(row.unitPrice) || 0) * (1 + (parseFloat(row.markup) || 0) / 100) * (parseFloat(project.regionFactor) || 1);
            csvContent += `"${row.item}","${row.category}",${row.quantity},"${row.unit}",${row.unitPrice},${row.markup},${finalCost.toFixed(2)}\r\n`;
        });
        
        csvContent += `\r\n,,,,,Subtotal,$${document.getElementById('subtotal').textContent.replace('$', '')}\r\n`;
        csvContent += `,,,,,Tax,$${document.getElementById('taxAmount').textContent.replace('$', '')}\r\n`;
        csvContent += `,,,,,Contingency,$${document.getElementById('contingencyAmount').textContent.replace('$', '')}\r\n`;
        csvContent += `,,,,,Grand Total,$${document.getElementById('grandTotal').textContent.replace('$', '')}\r\n`;

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `${project.name.replace(/[^a-z0-9]/gi, '_')}_estimate.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    // --- START APP --- //
    document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
